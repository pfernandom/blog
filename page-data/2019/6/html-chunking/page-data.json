{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019/6/html-chunking/","result":{"data":{"site":{"siteMetadata":{"title":"Pedro's Tech Blog","author":"Pedro Marquez"}},"markdownRemark":{"id":"c3e2a613-7580-513a-b1bd-ecd182a01f7d","excerpt":"An Express server showcasing how HTML Chunking behaves, including blocking resources for Critical Rendering Path Why? I’ve read from multiple sources about HTML…","html":"<p>An Express server showcasing how HTML Chunking behaves, including blocking resources for Critical Rendering Path</p>\n<h2>Why?</h2>\n<p>I’ve read from multiple sources about HTML streaming (chunking) as a way to increase perceived page load performance, but it was very difficult for me to visualize it without an example.</p>\n<p>Most examples I’ve seen don’t exactly show what happens if one chunk takes considerably more time to be streamed than the previous, or what happens with multiple chunks with varying latencies.</p>\n<h3>Critical rendering Path</h3>\n<p>Another thing that was difficult to visualize to me were concepts like “blocking resources” like CSS and JS files; especially because HTML can be rendered in chunks one would think that CSS and JS can be chunked too.</p>\n<p>This project adds blocking CSS and JS scripts which finish loading after a timeout, specifically to verify what happens when we also stream blocking resources (<em>spoiler alert, they still block rendering of the HTML</em>)</p>\n<h2>How</h2>\n<p>Node’s Express allows writing chunks into a response stream using <a href=\"https://nodejs.org/api/stream.html#stream_writable_write_chunk_encoding_callback\">Node streams</a>, via its <code class=\"language-text\">response.write(chunk)</code> method.</p>\n<p>Using that method, we can simulate streaming multiple chunks with different latencies:</p>\n<div id=\"gist117421660\" class=\"gist\">\n    <div class=\"gist-file\" translate=\"no\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-blog-gist-2019-6-html-chunking-0-js\" class=\"file my-2\">\n    \n    <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-javascript  \">\n\n        \n<div class=\"js-check-bidi js-blob-code-container blob-code-content\">\n\n  <template class=\"js-file-alert-template\">\n  <div data-view-component=\"true\" class=\"flash flash-warn flash-full d-flex flex-items-center\">\n  <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n  \n    <span>\n      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.\n      <a href=\"https://github.co/hiddenchars\" target=\"_blank\">Learn more about bidirectional Unicode characters</a>\n    </span>\n\n\n  <div data-view-component=\"true\" class=\"flash-action\">      <a href=\"{{ revealButtonHref }}\" data-view-component=\"true\" class=\"btn-sm btn\">  Show hidden characters\n  \n</a>\n</div>\n</div></template>\n<template class=\"js-line-alert-template\">\n  <span aria-label=\"This line has hidden Unicode characters\" data-view-component=\"true\" class=\"line-alert tooltipped tooltipped-e\">\n    <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n</span></template>\n\n  <table data-hpc class=\"highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file js-search-container\" data-tab-size=\"8\" data-paste-markdown-skip data-tagsearch-lang=\"JavaScript\" data-tagsearch-path=\"blog-gist-2019-6-html-chunking-0.js\">\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L1\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"1\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-s1>app</span><span class=pl-kos>.</span><span class=pl-en>get</span><span class=pl-kos>(</span><span class=pl-s>&#39;/&#39;</span><span class=pl-kos>,</span> <span class=pl-k>function</span> <span class=pl-kos>(</span><span class=pl-s1>req</span><span class=pl-kos>,</span> <span class=pl-s1>res</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L2\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"2\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC2\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;&lt;html&gt;&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L3\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"3\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC3\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;&lt;h1 class=&quot;my-text&quot;&gt;Hello&lt;/h1&gt;&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L4\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"4\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC4\" class=\"blob-code blob-code-inner js-file-line\">  </td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L5\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"5\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC5\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-en>setTimeout</span><span class=pl-kos>(</span><span class=pl-k>function</span><span class=pl-kos>(</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L6\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"6\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC6\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&quot;&lt;div&gt;I took too long to load, like 5 seconds!&lt;/div&gt;&quot;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L7\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"7\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC7\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;&lt;/html&gt;&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L8\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"8\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC8\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>end</span><span class=pl-kos>(</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L9\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"9\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC9\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-kos>}</span><span class=pl-kos>,</span> <span class=pl-c1>5000</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-L10\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"10\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-0-js-LC10\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-kos>}</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n  </table>\n</div>\n\n\n    </div>\n\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68/raw/88f38ee17c72e18091400a02c4bf23d9811527d9/blog-gist-2019-6-html-chunking-0.js\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68#file-blog-gist-2019-6-html-chunking-0-js\">\n          blog-gist-2019-6-html-chunking-0.js\n        </a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div>\n<p>Here, we stream first the openning tag <code class=\"language-text\">&lt;html></code> and the <code class=\"language-text\">&lt;h1></code> tag, then we wait for 5 seconds and we stream the rest of the document.</p>\n<p>In a real-world application, instead of a timeout we can do some costly operation like querying a DB. The browser will render the <code class=\"language-text\">&lt;h1></code> element and as more chunks are streamed, more parts of the page will be rendered.\nIn this way, we can get content to the user as fast as possible, without having to wait for those costly operations to finish before even sending the first byte of response.</p>\n<h3>Scripts and stylesheets</h3>\n<p>Using the same chunking technique, we can return JS and CSS files:</p>\n<div id=\"gist117421660\" class=\"gist\">\n    <div class=\"gist-file\" translate=\"no\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-blog-gist-2019-6-html-chunking-1-js\" class=\"file my-2\">\n    \n    <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-javascript  \">\n\n        \n<div class=\"js-check-bidi js-blob-code-container blob-code-content\">\n\n  <template class=\"js-file-alert-template\">\n  <div data-view-component=\"true\" class=\"flash flash-warn flash-full d-flex flex-items-center\">\n  <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n  \n    <span>\n      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.\n      <a href=\"https://github.co/hiddenchars\" target=\"_blank\">Learn more about bidirectional Unicode characters</a>\n    </span>\n\n\n  <div data-view-component=\"true\" class=\"flash-action\">      <a href=\"{{ revealButtonHref }}\" data-view-component=\"true\" class=\"btn-sm btn\">  Show hidden characters\n  \n</a>\n</div>\n</div></template>\n<template class=\"js-line-alert-template\">\n  <span aria-label=\"This line has hidden Unicode characters\" data-view-component=\"true\" class=\"line-alert tooltipped tooltipped-e\">\n    <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n</span></template>\n\n  <table data-hpc class=\"highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file js-search-container\" data-tab-size=\"8\" data-paste-markdown-skip data-tagsearch-lang=\"JavaScript\" data-tagsearch-path=\"blog-gist-2019-6-html-chunking-1.js\">\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L1\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"1\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-s1>app</span><span class=pl-kos>.</span><span class=pl-en>get</span><span class=pl-kos>(</span><span class=pl-s>&#39;/styles.css&#39;</span><span class=pl-kos>,</span> <span class=pl-k>function</span> <span class=pl-kos>(</span><span class=pl-s1>req</span><span class=pl-kos>,</span> <span class=pl-s1>res</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L2\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"2\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC2\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;h1 { background-color:blue; }&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L3\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"3\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC3\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;.my-text { background-color:yellow; }&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L4\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"4\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC4\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-en>setTimeout</span><span class=pl-kos>(</span><span class=pl-k>function</span><span class=pl-kos>(</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L5\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"5\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC5\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&quot; body { background-color: grey; }&quot;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L6\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"6\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC6\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>end</span><span class=pl-kos>(</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L7\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"7\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC7\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-kos>}</span><span class=pl-kos>,</span> <span class=pl-c1>4000</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L8\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"8\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC8\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-kos>}</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L9\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"9\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC9\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L10\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"10\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC10\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-s1>app</span><span class=pl-kos>.</span><span class=pl-en>get</span><span class=pl-kos>(</span><span class=pl-s>&#39;/script.js&#39;</span><span class=pl-kos>,</span> <span class=pl-k>function</span> <span class=pl-kos>(</span><span class=pl-s1>req</span><span class=pl-kos>,</span> <span class=pl-s1>res</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L11\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"11\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC11\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;console.log(&quot;hello&quot;);&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L12\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"12\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC12\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-en>setTimeout</span><span class=pl-kos>(</span><span class=pl-k>function</span><span class=pl-kos>(</span><span class=pl-kos>)</span> <span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L13\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"13\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC13\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>write</span><span class=pl-kos>(</span><span class=pl-s>&#39;console.log(&quot;world&quot;);&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L14\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"14\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC14\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>res</span><span class=pl-kos>.</span><span class=pl-en>end</span><span class=pl-kos>(</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L15\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"15\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC15\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-kos>}</span><span class=pl-kos>,</span> <span class=pl-c1>4000</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-L16\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"16\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-1-js-LC16\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-kos>}</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n  </table>\n</div>\n\n\n    </div>\n\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68/raw/88f38ee17c72e18091400a02c4bf23d9811527d9/blog-gist-2019-6-html-chunking-1.js\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68#file-blog-gist-2019-6-html-chunking-1-js\">\n          blog-gist-2019-6-html-chunking-1.js\n        </a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div>\n<p>Unlike the chunked HTML, the browser will not execute/render each chunk as it gets it. It has to wait for the whole file to finish loading before it can continuing rendering the HTML which is declared after these <code class=\"language-text\">&lt;link></code> and <code class=\"language-text\">&lt;script></code> tags. So, even if we stream these resources, they will still block rendering.\nFor example, once the browser gets to the <code class=\"language-text\">&lt;script></code> tag for the <code class=\"language-text\">script.js</code> file we defined above, both <code class=\"language-text\">hello</code> and <code class=\"language-text\">world</code> will be printed in console at the same time, after the 4 seconds delay.</p>\n<p>Why is the browser not processing these files as they get streamed? This is out of the scope of this text, but from a high point of view is because <strong>the browser cannot correctly calculate styles or execute scripts without knowing the whole content of the file</strong>.\nTake as an example a JavaScript file. Thanks to <a href=\"https://www.w3schools.com/js/js_hoisting.asp\">hoisting</a>, declarations of JavaScript functions can be bellow their invocations:</p>\n<div id=\"gist117421660\" class=\"gist\">\n    <div class=\"gist-file\" translate=\"no\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-blog-gist-2019-6-html-chunking-2-js\" class=\"file my-2\">\n    \n    <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-javascript  \">\n\n        \n<div class=\"js-check-bidi js-blob-code-container blob-code-content\">\n\n  <template class=\"js-file-alert-template\">\n  <div data-view-component=\"true\" class=\"flash flash-warn flash-full d-flex flex-items-center\">\n  <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n  \n    <span>\n      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.\n      <a href=\"https://github.co/hiddenchars\" target=\"_blank\">Learn more about bidirectional Unicode characters</a>\n    </span>\n\n\n  <div data-view-component=\"true\" class=\"flash-action\">      <a href=\"{{ revealButtonHref }}\" data-view-component=\"true\" class=\"btn-sm btn\">  Show hidden characters\n  \n</a>\n</div>\n</div></template>\n<template class=\"js-line-alert-template\">\n  <span aria-label=\"This line has hidden Unicode characters\" data-view-component=\"true\" class=\"line-alert tooltipped tooltipped-e\">\n    <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-alert\">\n    <path fill-rule=\"evenodd\" d=\"M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z\"></path>\n</svg>\n</span></template>\n\n  <table data-hpc class=\"highlight tab-size js-file-line-container js-code-nav-container js-tagsearch-file js-search-container\" data-tab-size=\"8\" data-paste-markdown-skip data-tagsearch-lang=\"JavaScript\" data-tagsearch-path=\"blog-gist-2019-6-html-chunking-2.js\">\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-L1\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"1\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-en>main</span><span class=pl-kos>(</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-L2\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"2\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-LC2\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-L3\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"3\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-LC3\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>function</span> <span class=pl-en>main</span><span class=pl-kos>(</span><span class=pl-kos>)</span><span class=pl-kos>{</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-L4\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"4\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-LC4\" class=\"blob-code blob-code-inner js-file-line\">  <span class=pl-smi>console</span><span class=pl-kos>.</span><span class=pl-en>log</span><span class=pl-kos>(</span><span class=pl-s>&#39;Go main!&#39;</span><span class=pl-kos>)</span><span class=pl-kos>;</span></td>\n        </tr>\n        <tr>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-L5\" class=\"blob-num js-line-number js-code-nav-line-number js-blob-rnum\" data-line-number=\"5\"></td>\n          <td id=\"file-blog-gist-2019-6-html-chunking-2-js-LC5\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-kos>}</span></td>\n        </tr>\n  </table>\n</div>\n\n\n    </div>\n\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68/raw/88f38ee17c72e18091400a02c4bf23d9811527d9/blog-gist-2019-6-html-chunking-2.js\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/pfernandom/72b7617e3acb951967b31c2e5bed1d68#file-blog-gist-2019-6-html-chunking-2-js\">\n          blog-gist-2019-6-html-chunking-2.js\n        </a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div>\n<p>So, even if the browser browser is able to read the first line with <code class=\"language-text\">main()</code>, how would it know what to execute if it doesn’t have the function declaration yet?.</p>\n<h3>Fixing blocking resources</h3>\n<p>There are multiple ways to remove blocking CSS and JS, like inlining critical CSS and JS. It won’t change the blocking behavior of the <code class=\"language-text\">&lt;script></code> and <code class=\"language-text\">&lt;link></code> tags, but it will reduce the overhead of extra network requests and (hopefully) it will be smaller in content than the full, non-critical resources.</p>\n<ul>\n<li><a href=\"https://developers.google.com/speed/docs/insights/BlockingJS\">https://developers.google.com/speed/docs/insights/BlockingJS</a></li>\n</ul>\n<p>##Demo\n<img src=\"/54c282e15daa4dcc94ef0eb9821ef2fb/demo.gif\" alt=\"Gif showing the server running\"></p>","frontmatter":{"title":"Streaming HTML responses","date":"June 21, 2019","description":"How does HTML chunking work when streaming HTML files to the browser?"}}},"pageContext":{"slug":"/2019/6/html-chunking/","previous":null,"next":{"fields":{"slug":"/2019/7/array-fill/"},"frontmatter":{"title":"Weird behavior for matrix created with Array.fill()"}}}},"staticQueryHashes":["426816048","63159454"]}