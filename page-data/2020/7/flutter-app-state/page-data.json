{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/7/flutter-app-state/","result":{"data":{"site":{"siteMetadata":{"title":"Pedro's Tech Blog","author":"Pedro Marquez"}},"markdownRemark":{"id":"4a7192c7-a432-5632-8bf0-46fb5c8fa497","excerpt":"Managing state in a client app is always a tricky (and opinionated) topic.\nWeb developers are familiar with tools like Redux or MobX. These tools follow very…","html":"<p>Managing state in a client app is always a tricky (and opinionated) topic.\nWeb developers are familiar with tools like Redux or MobX. These tools follow very specific patterns that are not always easy to learn or understand by new developers. </p>\n<p>These same tools exist in the Flutter world, but recently I’ve been exploring an alternative that may seem consistently easier. We can manage app state with rxdart and get_it.</p>\n<h1>Some background</h1>\n<p>At any given moment, an application will have <em>state</em>. If we think of an app like Instagram, the state can be\nthe list of posts and stories the application renders. State can also be your app preferences, the contents of the\nstory you’re about to post, the list of notifications and the number of un-read messages.</p>\n<p>In general, state is data.</p>\n<p>Let’s think of notifications. When a user sends you a message, many components in the application need to reflect this change of state: The little red dot that tells you have un-red messages must be rendered, the list of messages must be updated, and so on.</p>\n<p>At a lower level, state is a collection of variables. In Flutter, we extend the <code class=\"language-text\">StatefulWidget</code> class when we want to create a widget that will contain state:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter/material.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Update</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>required <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">String</span> description<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyStatefulWidget</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatefulWidget</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">State</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">StatefulWidget</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">createState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">MyStatefulWidgetState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyStatefulWidgetState</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">State</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MyStatefulWidget</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Update</span><span class=\"token punctuation\">></span></span> updates <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Updates: </span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">updates</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Column</span><span class=\"token punctuation\">(</span>\n      children<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">ElevatedButton</span><span class=\"token punctuation\">(</span>\n          onPressed<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">fetchUpdates</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>newUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                updates <span class=\"token operator\">=</span> newUpdates<span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          child<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Fetch notifications\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Flexible</span><span class=\"token punctuation\">(</span>\n          child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ListView</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span>\n            itemCount<span class=\"token punctuation\">:</span> updates<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n            itemBuilder<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">,</span> int index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">return</span> <span class=\"token class-name\">ListTile</span><span class=\"token punctuation\">(</span>\n                title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>updates<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">MyStatefulWidgetState</code> widget renders the following view:</p>\n<p><img src=\"/e05cbd91cc1e7f9f8fe2ac166bf9a66a/appstate1.gif\" alt=\"User clicks in the button and a list of notifications is rendered\"></p>\n<p>In this example, when the user clicks the <code class=\"language-text\">Fetch notifications</code> button, the function <code class=\"language-text\">fetchUpdates()</code> is called. This function returns a Future object, and once the request completes successfully, we set the list of updates in the variable <code class=\"language-text\">updates</code>.</p>\n<p>The variable <code class=\"language-text\">updates</code> is state within this widget.</p>\n<p>Calling <code class=\"language-text\">setState</code> when we set the new value of the variable <code class=\"language-text\">updates</code> will re-render this widget <em>only</em>. If this widget contains other widgets (e.g. the <code class=\"language-text\">ElevatedButton</code> and the <code class=\"language-text\">ListView</code>), those widgets will be re-rendered as well.</p>\n<p>Now, we want to add an icon to the top bar to indicate the user that new notifications have been fetched. The following widget will render that notification icon:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter/material.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">NotificationIcon</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatelessWidget</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> notificationsCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stack</span><span class=\"token punctuation\">(</span>\n        children<span class=\"token punctuation\">:</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Widget</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span>\n        <span class=\"token keyword\">const</span> <span class=\"token class-name\">Icon</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Icons</span><span class=\"token punctuation\">.</span>notifications<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Positioned</span><span class=\"token punctuation\">(</span>\n            right<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n            child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Container</span><span class=\"token punctuation\">(</span>\n            padding<span class=\"token punctuation\">:</span> <span class=\"token class-name\">EdgeInsets</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            decoration<span class=\"token punctuation\">:</span> <span class=\"token class-name\">BoxDecoration</span><span class=\"token punctuation\">(</span>\n                color<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">,</span>\n                borderRadius<span class=\"token punctuation\">:</span> <span class=\"token class-name\">BorderRadius</span><span class=\"token punctuation\">.</span><span class=\"token function\">circular</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            constraints<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">BoxConstraints</span><span class=\"token punctuation\">(</span>\n                minWidth<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n                minHeight<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string-literal\"><span class=\"token string\">'</span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">notificationsCount</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">,</span>\n                style<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">TextStyle</span><span class=\"token punctuation\">(</span>\n                color<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>white<span class=\"token punctuation\">,</span>\n                fontSize<span class=\"token punctuation\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                textAlign<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TextAlign</span><span class=\"token punctuation\">.</span>center<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>How can we notify the <code class=\"language-text\">NotificationIcon</code> widget that <code class=\"language-text\">MyStatefulWidget</code> has fetched a new list of notiications?</p>\n<h2>Some options…</h2>\n<p>We could re-render our component to include <code class=\"language-text\">NotificationIcon</code> in <code class=\"language-text\">MyStatefulWidget</code>. The problem with this approach is that we may need to also include other, unrelated widgets.</p>\n<p>Another approach is to use <a href=\"https://api.flutter.dev/flutter/widgets/InheritedWidget-class.html\">Inherited Widgets</a>. However, this approch may require us to modify other widgets than these two, which is not always possible.</p>\n<p>How can we notify to independent widgets of state changes? </p>\n<p>Enter state management.</p>\n<h1>State management through streams</h1>\n<p>Data streams are analog to queues: One part of the application will publish data to a stream and other parts of the application can subscribe that stream and consume the data it produces.</p>\n<p>We can rely on streams to communicate state changes across independent components.</p>\n<p>A popular implementation of streams for Flutter apps is <a href=\"https://pub.dev/packages/rxdart\">rxdart</a>.</p>\n<p>We can add them to our project with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">flutter pub add rxdart</code></pre></div>\n<h2>Creating a stream</h2>\n<p>Then, we can create a service to create a stream:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:rxdart/rxdart.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'MyStatefulWidget.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">NotificationsService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">BehaviorSubject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Update</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> notificationSubject <span class=\"token operator\">=</span> <span class=\"token class-name\">BehaviorSubject</span><span class=\"token punctuation\">.</span><span class=\"token function\">seeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">ValueStream</span> <span class=\"token keyword\">get</span> stream$ <span class=\"token operator\">=</span><span class=\"token operator\">></span> notificationSubject<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">;</span>\n  \n  <span class=\"token function\">updateNotifications</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Update</span><span class=\"token punctuation\">></span></span> updates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    notificationSubject<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>updates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Before we can use this service, we need a way for widgets to access a shared instance of the stream. For this, we will use <a href=\"https://pub.dev/packages/get_it\">get_it</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">flutter pub add get_it</code></pre></div>\n<h2>Registering a service</h2>\n<p>This tools is a <strong>service locator</strong>: It allows us to create singleton instances of objects and share it across the application without having to pass them as paramaters.</p>\n<p>We can create an instance of <code class=\"language-text\">NotificationService</code> when the app starts as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">GetIt</span> getIt <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token punctuation\">;</span>\n  getIt<span class=\"token punctuation\">.</span>registerSingleton<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NotificationsService</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NotificationsService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">runApp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token class-name\">MyApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, anywhere in our app, we can get this singleton instance with the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token class-name\">GetIt</span> getIt <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> service <span class=\"token operator\">=</span> getIt<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NotificationsService</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We update <code class=\"language-text\">MyStatefulWidgetState</code> to get the service, and send the new updates to the stream:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token function\">fetchUpdates</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>newUpdates<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">GetIt</span> getIt <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> service <span class=\"token operator\">=</span> getIt<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NotificationsService</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    service<span class=\"token punctuation\">.</span><span class=\"token function\">updateNotifications</span><span class=\"token punctuation\">(</span>newUpdates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h2>Subscribing to the stream</h2>\n<p>Now, we will update <code class=\"language-text\">NotificationIcon</code> to subscribe to the stream and listen for new updates.</p>\n<p>For this, we will use <code class=\"language-text\">StreamBuilder</code>, which accepts a stream and re-renders its contents when the stream produces new results.</p>\n<p>The following code shows the updated version of <code class=\"language-text\">NotificationIcon</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:flutter/material.dart'</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'package:get_it/get_it.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'MyStatefulWidget.dart'</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string-literal\"><span class=\"token string\">'NotificationsService.dart'</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">NotificationIcon</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatelessWidget</span> <span class=\"token punctuation\">{</span>\n  late <span class=\"token class-name\">NotificationsService</span> service<span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">NotificationIcon</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">GetIt</span> getIt <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token punctuation\">;</span>\n    service <span class=\"token operator\">=</span> getIt<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NotificationsService</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">StreamBuilder</span><span class=\"token punctuation\">(</span>\n      stream<span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">.</span>stream$<span class=\"token punctuation\">,</span>\n      builder<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AsyncSnapshot</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">dynamic</span><span class=\"token punctuation\">></span></span> snapshot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>snapshot<span class=\"token punctuation\">.</span>hasData <span class=\"token operator\">||</span> snapshot<span class=\"token punctuation\">.</span>data <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">CircularProgressIndicator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Update</span><span class=\"token punctuation\">></span></span> updates <span class=\"token operator\">=</span> snapshot<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updates<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token class-name\">Container</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">var</span> notificationsCount <span class=\"token operator\">=</span> updates<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Stack</span><span class=\"token punctuation\">(</span>\n          children<span class=\"token punctuation\">:</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Widget</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span>\n            <span class=\"token keyword\">const</span> <span class=\"token class-name\">Icon</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Icons</span><span class=\"token punctuation\">.</span>notifications<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Positioned</span><span class=\"token punctuation\">(</span>\n              right<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n              child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Container</span><span class=\"token punctuation\">(</span>\n                padding<span class=\"token punctuation\">:</span> <span class=\"token class-name\">EdgeInsets</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                decoration<span class=\"token punctuation\">:</span> <span class=\"token class-name\">BoxDecoration</span><span class=\"token punctuation\">(</span>\n                  color<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">,</span>\n                  borderRadius<span class=\"token punctuation\">:</span> <span class=\"token class-name\">BorderRadius</span><span class=\"token punctuation\">.</span><span class=\"token function\">circular</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                constraints<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">BoxConstraints</span><span class=\"token punctuation\">(</span>\n                  minWidth<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n                  minHeight<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>\n                  <span class=\"token string-literal\"><span class=\"token string\">'</span><span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token expression\">notificationsCount</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">,</span>\n                  style<span class=\"token punctuation\">:</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">TextStyle</span><span class=\"token punctuation\">(</span>\n                    color<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Colors</span><span class=\"token punctuation\">.</span>white<span class=\"token punctuation\">,</span>\n                    fontSize<span class=\"token punctuation\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n                  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                  textAlign<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TextAlign</span><span class=\"token punctuation\">.</span>center<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Focus on the important part here:</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"> <span class=\"token keyword\">return</span> <span class=\"token class-name\">StreamBuilder</span><span class=\"token punctuation\">(</span>\n      stream<span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">.</span>stream$<span class=\"token punctuation\">,</span>\n      builder<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AsyncSnapshot</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">dynamic</span><span class=\"token punctuation\">></span></span> snapshot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>snapshot<span class=\"token punctuation\">.</span>hasData <span class=\"token operator\">||</span> snapshot<span class=\"token punctuation\">.</span>data <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">CircularProgressIndicator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Update</span><span class=\"token punctuation\">></span></span> updates <span class=\"token operator\">=</span> snapshot<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updates<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token class-name\">Container</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">var</span> notificationsCount <span class=\"token operator\">=</span> updates<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ... render the notification icon</span></code></pre></div>\n<p>Since the stream may be empty, we need to handle the case where the widget has not received any updates. The class <code class=\"language-text\">AsyncSnapshot</code> has multiple methods that allow us to check the stream state and act accordingly.</p>\n<p>Now, when the user clicks in the button, the new updates will be sent to the stream and all widgets listening to it will re-render:</p>\n<p><img src=\"/a7b95d5f07ed29c7d3ba4d3b5a3c76fe/appstate2.gif\" alt=\"User clicks in the button, a list of notifications is rendered and the notification icon is rendered as well.\"></p>\n<p>We could take this example even further and make <code class=\"language-text\">MyStatefulWidgetState</code> a stateless widget, getting its state directly from the same stream. Feel free to take this extra step and practice this state management approach.</p>\n<h1>Pros and cons</h1>\n<p>Some of the advantages of this state management approach are:</p>\n<ul>\n<li>It is simple. Multiple, independent widgets can be notified of state changes without changing their parent widgets, and without passing any extra props.</li>\n<li>It allows us to use more stateless widgets. Stateless widgets have a more predictable behavior, and require less boilerplate code.</li>\n<li>It reduces unnecessary re-rendering. If we were to pass app state as properties through the widget tree, all intermediate widgets will be re-rendered when state changes. With this approach, only the widgets that need to re-render do so.</li>\n<li>Less conventions. There is no defined API to follow. No reducers or mappers. While conventions are useful for large projects, smaller apps can benefit of the flexibility this approach provides.</li>\n</ul>\n<p>On the other side, the disadvantages are:</p>\n<ul>\n<li>It may be <em>too</em> flexible. This approach opens the door to a lack of structure in the project. More structure is better for large teams and large code bases.</li>\n<li>If not used responsibly, <code class=\"language-text\">get_it</code> can lead to a bunch of global state. Developers can abuse the magic of this service locator and add state that doesn’t need to be stored.</li>\n</ul>\n<h1>Conclusion</h1>\n<p>State management is hard. Because of these, developers have created many tools to store state and communicate state changes. Some of those tools will fit better to your specific project needs.</p>\n<p>Using streams along with a service locator is a simple yet effective way to handle global state.</p>","frontmatter":{"title":"Managing state in Flutter apps with streaming (Rxdart and get_it)","date":"July 18, 2022","description":"How does HTML chunking work when streaming HTML files to the browser?"}}},"pageContext":{"slug":"/2020/7/flutter-app-state/","previous":{"fields":{"slug":"/2020/7/component-wonder/"},"frontmatter":{"title":"The wonderful world of component-based development"}},"next":null}},"staticQueryHashes":["426816048","63159454"]}